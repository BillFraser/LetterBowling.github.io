<!DOCTYPE HTML>
<html>
<head>
	<title>Letter Bowling</title>
	<link rel="icon" type="image/x-icon" href="/favicon.ico">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<meta http-equiv="cleartype" content="on">
	<style>
		.frameTable {
		  height: 50px;
		}
		.frameScore {
		  display: inline-block;
		  min-width: 40px;
		  max-width: 40px;
		  width: 40px;
		  height: 40px;
		}
		.navbar {
		  overflow: hidden;
		  background-color: #333;
		  font-family: Arial, Helvetica, sans-serif;
		}
		.navbar a {
		  float: left;
		  font-size: 16px;
		  color: white;
		  text-align: center;
		  padding: 14px 16px;
		  text-decoration: none;
		}
		.dropdown {
		  float: left;
		  overflow: hidden;
		}
		.dropdown .dropbtn {
		  cursor: pointer;
		  font-size: 16px;  
		  border: none;
		  outline: none;
		  color: white;
		  padding: 14px 16px;
		  background-color: inherit;
		  font-family: inherit;
		  margin: 0;
		}
		.navbar a:hover, .dropdown:hover .dropbtn, .dropbtn:focus {
		  background-color: red;
		}
		.dropdown-content {
		  display: none;
		  position: absolute;
		  background-color: #f9f9f9;
		  min-width: 160px;
		  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
		  z-index: 1;
		}
		.dropdown-content a {
		  float: none;
		  color: black;
		  padding: 12px 16px;
		  text-decoration: none;
		  display: block;
		  text-align: left;
		}
		.dropdown-content a:hover {
		  background-color: #ddd;
		}
		.show {
		  display: block;
		}
		.pin0  {grid-area: pin0;}
		.pin1  {grid-area: pin1;}
		.pin2  {grid-area: pin2;}
		.pin3  {grid-area: pin3;}
		.pin4  {grid-area: pin4;}
		.pin5  {grid-area: pin5;}
		.pin6  {grid-area: pin6;}
		.pin7  {grid-area: pin7;}
		.pin8  {grid-area: pin8;}
		.pin9  {grid-area: pin9;}

		.pin-container {
			display: grid;
			grid-template-areas:
				'pin6 pin3 pin7 pin4 pin8 pin5 pin9'
				'pin6 pin3 pin7 pin4 pin8 pin5 pin9'
				'pin6 pin3 pin1 pin4 pin2 pin5 pin9'
				'pin6 pin3 pin1 pin0 pin2 pin5 pin9'
				'pin6 pin3 pin1 pin0 pin2 pin5 pin9'
		}
		.pin-container-container {
			margin-top: 20;
			display: inline-block;
			width: 300px;
			max-width: 300px;
			min-width: 300px;
			height: 200px;
		}
	</style>
</head>
<body class="input">

	<div class="navbar">
	  <div class="dropdown">
	    <button class="dropbtn" onClick="menuFile()">File</button>
	    <div class="dropdown-content" id="fileDropdown">
	      <a href="#" onClick="todayGame()">Today's Game</a>
	      <a href="#" onClick="nextGame()">Next Game</a>
	      <a href="#" onClick="randomGame()">Random Game</a>
	      <a href="#" onClick="restoreGame()">Restore Game</a>
	      <a href="#" onClick="openGame()">Open</a>
	      <a href="#" onClick="downloadGame()">Save</a>
	      <a href="#" onClick="changeDictionary()">Change Dictionary</a>
	      <a href="#" onClick="resetDictionary()">Reset Dictionary</a>
	    </div>
	  </div>
	  <div class="dropdown">
	    <button class="dropbtn" onClick="menuSettings()">Settings</button>
	    <div class="dropdown-content" id="settingsDropdown">
	      <a href="#" id="autoAdvance" onClick="toggleMenuPref('autoAdvance')"><span id="autoAdvanceCheck">&#x2713</span> Auto Advance After Each Frame</a>
	      <a href="#" id="checkWords" onClick="toggleMenuPref('checkWords')"><span id="checkWordsCheck">&#x2713</span> Check Words Against Dictionary</a>
	      <a href="#" id="hideStrke" onClick="toggleMenuPref('hideStrike')"><span id="hideStrikeCheck">&#x2713</span> Hide Strike Words</a>
	      <a href="#" id="currentFrameScoring" onClick="toggleMenuPref('currentFrameScoring')"><span id="currentFrameScoringCheck">&#x2713</span> Use Current Frame Scoring System</a>
	      <a href="#" id="allowGutterBalls" onClick="toggleMenuPref('allowGutterBalls')"><span id="allowGutterBallsCheck">&#x2713</span> Allow Gutter Balls</a>
	      <a href="#" onClick="resetMenuPrefs()">Reset Preferences</a>
	    </div>
	  </div>
	  <div class="dropdown">
	    <button class="dropbtn" onClick="menuHelp()">Help</button>
	    <div class="dropdown-content" id="helpDropdown">
	      <a href="#" onClick="gotoHelp('helpOverview')">Game Overview</a>
	      <a href="#" onClick="gotoHelp('helpThrow')">Valid Throws</a>
	      <a href="#" onClick="gotoHelp('helpWords')">Valid Words</a>
	      <a href="#" onClick="gotoHelp('helpScore')">The Score Area</a>
	      <a href="#" onClick="gotoHelp('helpGeeks')">Notes for Geeks</a>
	      <a href="#" onClick="gotoHelp('helpAbout')">About</a>
	      <a href="#" onClick="gotoHelp('main')">Return to Game</a>
	    </div>
	  </div>
	</div>
<div id="main">
	<div class="pin-container-container"><div class="pin-container">
	  <div class="pin0"><canvas id="pin0" width="85" height="85" onClick="pinClick(0)"></canvas></div>
	  <div class="pin1"><canvas id="pin1" width="85" height="127" onClick="pinClick(1)"></canvas></div>
	  <div class="pin2"><canvas id="pin2" width="85" height="127" onClick="pinClick(2)"></canvas></div>
	  <div class="pin3"><canvas id="pin3" width="85" height="212" onClick="pinClick(3)"></canvas></div>
	  <div class="pin4"><canvas id="pin4" width="85" height="127" onClick="pinClick(4)"></canvas></div>
	  <div class="pin5"><canvas id="pin5" width="85" height="212" onClick="pinClick(5)"></canvas></div>
	  <div class="pin6"><canvas id="pin6" width="85" height="212" onClick="pinClick(6)"></canvas></div>
	  <div class="pin7"><canvas id="pin7" width="85" height="85" onClick="pinClick(7)"></canvas></div>
	  <div class="pin8"><canvas id="pin8" width="85" height="85" onClick="pinClick(8)"></canvas></div>
	  <div class="pin9"><canvas id="pin9" width="85" height="212" onClick="pinClick(9)"></canvas></div>
	</div></div>
	<p>
	<table>
	  <tr>
	    <td>
		<button id="seed" onClick="nextGame()"/>
	    </td>
	    <td/>
	    <td>
		<span id="strike"></span>
	    </td>
	  </tr>
	  <tr>
	    <td>
		<button id="nextFrame" onClick="nextFrame()"/>Next Frame
	    </td>
	    <td/>
	    <td>
		<span id="bowlingBall">Bowling Ball Here!</span>
	    </td>
	  </tr>
	  <tr>
	    <td>
		<button id="btnCheckWords" onClick="toggleMenuPref('checkWords')"/>&#x2713;
	    </td>
	    <td>
		<input id="word"></input>
	    </td>
	    <td>
		<button id="bowl" onClick="bowl()"/>Bowl
	    </td>
	  </tr>
	  <tr>
	    <td>
		<div class="frameTable"><table><tr>
		  <td><div class="frameScore"><canvas id="scoreArea0" onClick="frameClick(0)"></canvas></div></td>
		  <td><div class="frameScore"><canvas id="scoreArea1" onClick="frameClick(1)"></canvas></div></td>
		  <td><div class="frameScore"><canvas id="scoreArea2" onClick="frameClick(2)"></canvas></div></td>
		  <td><div class="frameScore"><canvas id="scoreArea3" onClick="frameClick(3)"></canvas></div></td>
		  <td><div class="frameScore"><canvas id="scoreArea4" onClick="frameClick(4)"></canvas></div></td>
		  <td><div class="frameScore"><canvas id="scoreArea5" onClick="frameClick(5)"></canvas></div></td>
		  <td><div class="frameScore"><canvas id="scoreArea6" onClick="frameClick(6)"></canvas></div></td>
		  <td><div class="frameScore"><canvas id="scoreArea7" onClick="frameClick(7)"></canvas></div></td>
		  <td><div class="frameScore"><canvas id="scoreArea8" onClick="frameClick(8)"></canvas></div></td>
		  <td><div class="frameScore"><canvas id="scoreArea9" onClick="frameClick(9)"></canvas></div></td>
		  <td><div class="frameScore"><canvas id="scoreArea10" onClick="frameClick(10)"></canvas></div></td>
		  <td><div class="frameScore"><canvas id="totalScoreArea"></canvas></div></td>
		</tr></table></div>
	    </td>
	  </tr>
	  <tr>
	    <td>
		<table>
		  <tr>
		    <td><span id="word0"/></td>
		  </tr>
		  <tr>
		    <td><span id="word1"/></td>
		  </tr>
		  <tr>
		    <td><span id="word2"/></td>
		  </tr>
		  <tr>
		    <td><span id="word3"/></td>
		  </tr>
		  <tr>
		    <td><span id="word4"/></td>
		  </tr>
		  <tr>
		    <td><span id="word5"/></td>
		  </tr>
		  <tr>
		    <td><span id="word6"/></td>
		  </tr>
		  <tr>
		    <td><span id="word7"/></td>
		  </tr>
		  <tr>
		    <td><span id="word8"/></td>
		  </tr>
		  <tr>
		    <td><span id="word9"/></td>
		  </tr>
		  <tr>
		    <td><span id="word10"/></td>
		  </tr>
		  <tr>
		    <td><span id="word11"/></td>
		  </tr>
		  <tr>
		    <td><span id="word12"/></td>
		  </tr>
		  <tr>
		    <td><span id="word13"/></td>
		  </tr>
		  <tr>
		    <td><span id="word14"/></td>
		  </tr>
		  <tr>
		    <td><span id="word15"/></td>
		  </tr>
		  <tr>
		    <td><span id="word16"/></td>
		  </tr>
		  <tr>
		    <td><span id="word17"/></td>
		  </tr>
		  <tr>
		    <td><span id="word18"/></td>
		  </tr>
		  <tr>
		    <td><span id="word19"/></td>
		  </tr>
		  <tr>
		    <td><span id="word20"/></td>
		  </tr>
		  <tr>
		    <td><span id="word21"/></td>
		  </tr>
		</table>
	    </td>
	    <td/>
	    <td>
		<div id="messages"/>
	    </td>
	  </tr>
	</table>
	<p>
</div>

<div id="helpOverview" style="display:none">
<center>
<canvas id="bb0" width="85px" height="85px"></canvas><p>
<H1>Game Overview</H1>
</center>
As in regular bowling, each frame you have two tries to knock down as many pins as possible.<P><P>

You knock down pins by typing a word and clicking &quot;Bowl&quot; (or hitting Enter).<P><P>

By default, you must click &quot;Next Frame&quot; after each frame.<P>
<CENTER>*&nbsp;*&nbsp;*</CENTER><P><P>
The button with the hexadecimal string &quot;<span id="seedSpan"></span>&quot; indicates that this value was used as the random seed to generate the current game.
Clicking on this button will allow you to start a new game.<P><P>

By specifying the same seed as someone else, you can play the same sets of letters, which reduces The element of luck when comparing scores.<P><P>

<center><table><tr>
<td><button onClick="gotoHelp('main')">Return to game</button></td>
<td><button onClick="gotoHelp('helpThrow')">&gt;&gt;</button></td>
</tr></table></center>
</div>

<div id="helpThrow" style="display:none">
<center>
<canvas id="bb1" width="85px" height="85px"></canvas><p>
<H1>Valid Throws</H1>
</center>
In order for a throw to be valid, the following must be true (which will turn the corresponding elements of the UI green):<UL>

<LI>There must be a unique character representing the bowling ball.
The bowling ball must occur one or more times in the word.
The bowling ball must not match any of the bowling pins.
If there is no bowling ball, the text &quot;N/A&quot; will appear in pink above the &quot;Bowl&quot; button.
If there is more than one bowling ball, the letters will appear in red above the &quot;Bowl&quot; button.<P>

<LI>With the exception of the bowling ball letter, a letter may not appear in the word more times than it appears on the bowling pins.  If it does, the corresponding bowling pins will be turned red.<P>

<LI>The bowling pins which are knocked down must be adjacent (diagonally) and must include at least one of the seven front pins.
Otherwise, any pins which would have been colored green will be colored pink.
</UL>
One pin is knocked down for each character in the word which is not the bowling ball.
When a letter is used fewer times than there are corresponding pins, you may change which pins are knocked down by clicking on them.
<center><table><tr>
<td><button onClick="gotoHelp('helpOverview')">&lt;&lt;</button></td>
<td><button onClick="gotoHelp('main')">Return to game</button></td>
<td><button onClick="gotoHelp('helpWords')">&gt;&gt;</button></td>
</tr></table></center>
</div>

<div id="helpWords" style="display:none">
<center>
<canvas id="bb2" width="85px" height="85px"></canvas><p>
<H1>Valid Words</H1>
</center>
The default dictionary is the SOWPODS dictionary, which is the one that was formerly used in competition Scrabble.
You may provide a custom dictionary, provided that the words are uppercase and sorted using Java's default collation.
It should not be necessary that the words be English. (Let me know if you have trouble....)<P><P>

The set of pins for each frame are chosen such that at least one word from the dictionary will knock down all ten.
Because it must contain all ten pin letters and at least one bowling ball, the required word will have at least eleven letters.<P><P>

Be default, the check mark on the left turns green when the current word is in the dictionary.
If a word is entered that is not in the dictionary, you are given the option of using it anyway.<P><P>
<center><table><tr>
<td><button onClick="gotoHelp('helpThrow')">&lt;&lt;</button></td>
<td><button onClick="gotoHelp('main')">Return to game</button></td>
<td><button onClick="gotoHelp('helpScore')">&gt;&gt;</button></td>
</tr></table></center>
</div>

<div id="helpScore" style="display:none">
<center>
<canvas id="bb3" width="85px" height="85px"></canvas><p>
<H1>The Score Area</H1>
</center>
Although traditional scoring is supported, by default Letter Bowling uses &quot;Current Frame Scoring&quot;.
This form of scoring allows scores to be calculated as soon as a frame is completed.<P><P>

Points are scored as follows:
<UL>
<LI>Strike: 30 points
<LI>Spare: 10 points plus the pinfall of the first roll
<LI>Open: total pinfall</UL>
Note that Current Frame Scoring does not require an eleventh frame, so it will not appear.<P>
<CENTER>*&nbsp;*&nbsp;*</CENTER><P><P>

Clicking on a frame in the scoring area which has already been completed will cause the pins to be restored to that point in the game, for viewing only.<P><P>

To continue play, click on the current frame in the score area or click the &quot;Next Frame&quot; button.<P><P>
<center><table><tr>
<td><button onClick="gotoHelp('helpWords')">&lt;&lt;</button></td>
<td><button onClick="gotoHelp('main')">Return to game</button></td>
<td><button onClick="gotoHelp('helpGeeks')">&gt;&gt;</button></td>
</tr></table></center>
</div>

<div id="helpGeeks" style="display:none">
<center>
<canvas id="bb4" width="85px" height="85px"></canvas><p>
<H1>Notes for Geeks</H1>
</center>
Settings and the current game are remembered between sessions using localStorage.<P>
Games can also be saved explicitly.<P>&nbsp<P>

The seed for the next game is generated from the current seed, so if you play a series of games starting with a given seed, all of the games will be paired.<P><P>
<center><table><tr>
<td><button onClick="gotoHelp('helpScore')">&lt;&lt;</button></td>
<td><button onClick="gotoHelp('main')">Return to game</button></td>
</tr></table></center>
</div>

<div id="helpAbout" style="display:none">
<center>
<canvas id="bb5" width="85px" height="85px"></canvas><p>
Letter Bowling<p>
by William Fraser<p>
Version 20231116<p>&nbsp<p>
I'd love to hear feedback from anyone who uses this game!<p>
You can contact me at<p>
bfraser@alumni.ucsd.edu<p>
</center>
<center><table><tr>
<td><button onClick="gotoHelp('main')">Return to game</button></td>
</tr></table></center>
</div>

<input id="openFile" type="file" style="visibility:hidden" onChange="readGame(event)" />
<input id="openDictionary" type="file" style="visibility:hidden" onChange="readDictionary(event)" />

<script type="text/javascript">
	let dictionary=[];
	let pinSets=["ABCDEFGHIJ"];
	let strikeWords=[];
	let strikeBalls=[];

	let displayFrame=0;

	let playerName="Player";

	let ICON_WIDTH=84;
	let ICON_HEIGHT=84;

	let SCORE_WIDTH=40;
	let SCORE_HEIGHT=40;

	let x=[3,2,4,1,3,5,0,2,4,6];
	let y=[3,2,2,1,1,1,0,0,0,0];
	let yy=[0,0,0,42,42,42,0,0,0,0];

	let topScores=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
	let bottomScores=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];

	let paused=0;
	let downShape=0;
	let green=0;
	let pink=0;
	let red=0;

	let rng;
	let nextSeed;

	let savePaused;
	let saveDownShape;

	let connectedMask=[];

	function getSanitizedWord() {
		let word = document.getElementById("word").value.toUpperCase();
		var output=[];
		for(var i=0;i<word.length;i++)
			if(word[i]>' ')
				output.push(word[i]);
		return output.join("");
	}

	function isInDictionary(word) {
		var start=0;
		var end=dictionary.length-1;
		while(start <= end) {
			let middle = Math.floor((start + end) / 2);
			if(dictionary[middle] === word)
				return true;
			else if(dictionary[middle] < word)
				start = middle+1;
			else
				end = middle-1;
		}
		return false;
	}

	function update(newWord) {
		let word = getSanitizedWord();
		if(getPref("checkWords") && word.length>0) {
			document.getElementById("btnCheckWords").style.color="White";
			if(isInDictionary(word)) {
				document.getElementById("btnCheckWords").style.background="Green";
			} else {
				document.getElementById("btnCheckWords").style.background="Red";
			}
		} else {
			document.getElementById("btnCheckWords").style.background=null;
			document.getElementById("btnCheckWords").style.color=null;
		}
		let shouldBeGreen = 0;
		let shouldBeRed = 0;
		let bowl = "";
		for(var w=0;w<word.length;w++) {
			let c=word[w];
			if(pinSets[displayFrame].indexOf(c)<0) {
				if(bowl.indexOf(c)<0) {
					bowl = bowl+c;
					continue;
				}
			}
			let bestIndex=-1;
			let bestScore=0;
			for(var i=pinSets[displayFrame].indexOf(c);i>=0;i=pinSets[displayFrame].indexOf(c,i+1)) {
				if(((shouldBeGreen | shouldBeRed)&(1<<i))!=0)
					continue;
				var score=1;
				if((green | pink) & (1<<i))
					score += 10;
				if(!(downShape & (1<<i)))
					score ++;
				if(score>bestScore) {
					bestIndex=i;
					bestScore=score;
				}
			}
			if(bestIndex>=0)
				shouldBeGreen |= (1<<bestIndex);
			else {
				for(var i=pinSets[displayFrame].indexOf(c);i>=0;i=pinSets[displayFrame].indexOf(c,i+1)) {
					shouldBeGreen &= ~(1<<i);
					shouldBeRed |= (1<<i);
				}	
			}
		}
		var shouldBePink = determinePinkness(shouldBeGreen,shouldBeRed);
		if(shouldBePink!=0 && shouldBeRed==0 && newWord) {
			let match = shapeToString(shouldBePink);
			var bestScore = 0;
			for(var i=0;i<1024;i++) {
				m = shapeToString(i);
				if(m!==match)
					continue;
				var score=0;
				if(connectedMask[i])
					score += 100;
				score += 10*card(i &~ downShape);
				score += card(i & shouldBeGreen);
				if(score>bestScore) {
					shouldBePink = i;
					bestScore = score;
				}
			}
			if(connectedMask[shouldBePink]) {
				shouldBeGreen = shouldBePink;
				shouldBePink = 0;
			} else {
				shouldBeGreen = 0;
			}
		}
		green = shouldBeGreen;
		pink = shouldBePink;
		red = shouldBeRed;
		
		for(var i=0;i<10;i++) {
			const canvas = document.getElementById("pin"+i);
			const context = canvas.getContext("2d");
			context.font = "20px serif";
			var outline = determineOutlineColor(shouldBePink,shouldBeGreen,shouldBeRed,1<<i);
			drawBowlingPin(context,0,yy[i],pinSets && pinSets[displayFrame][i],outline,downShape & (1<<i));
		}
		if(bowl.length==0) {
			document.getElementById("bowlingBall").textContent="Bowling Ball: N/A";
			document.getElementById("bowlingBall").style.color="pink";
			document.getElementById("bowl").setAttribute("disabled","true");
		} else if(bowl.length==1) {
			document.getElementById("bowlingBall").textContent="Bowling Ball: "+bowl;
			document.getElementById("bowlingBall").style.color="green";
			if(shouldBePink==0 && shouldBeRed==0 && !paused && (getPref("allowGutterBalls") || shouldBeGreen!=0))
				enableButton("bowl",true);
			else
				enableButton("bowl",false);
		} else {
			document.getElementById("bowlingBall").textContent="Bowling Ball: "+bowl;
			document.getElementById("bowlingBall").style.color="red";
			document.getElementById("bowl").setAttribute("disabled","true");
		}
		var label="";
		if(word.length==0) {
			label = label+"No word entered yet<P><P>";
		} else if(word.length==1 && !getPref("allowGutterBalls")) {
			label = label+"A word must be at least two letters long<P><P>";
		} else {
			let selectedShape = shouldBeGreen | shouldBePink | shouldBeRed;
			if(document.getElementById("bowl").getAttribute("disabled")) {
				label = label+"<FONT COLOR=RED>You may not click bowl at this time for the following reason(s)</FONT><P><P>";
			} else  {
				label = label+"You may click \"Bowl\" to score this word<P><P>";
				if(selectedShape==0 && getPref("allowGutterBalls"))
					label = label+"But it is a gutter ball.<P>";
			}
			for(var i=0;i<10;i++) {
				if((shouldBeRed & (1<<i)) != 0) { 
					let c = pinSets[displayFrame].charAt(i);
					if(pinSets[displayFrame].indexOf(c)==i)
						label = label+"<FONT COLOR=RED>There are more copies of "+c+" in your "+
						"word than on the pins</FONT><P><P>";
				}
			}
			if(selectedShape==0) {
				if(!getPref("allowGutterBalls"))
					label = label+"<FONT COLOR=RED>No bowling pins are selected and gutter balls are not allowed</FONT><P>";
			} else if((selectedShape & 0x26F)==0)
				label = label+"<FONT COLOR=RED>At least one of the 7 front pins must be selected</FONT><P>";
			if(!connectedMask[selectedShape] && (selectedShape & 0x26F)!=0 || (selectedShape==0x180))
				label = label+"<FONT COLOR=RED>The selected bowling pins must be next to each other</FONT><P>";

			if(bowl.length==0)
				label = label+"<FONT COLOR=RED>No bowling ball letter is being used</FONT><P>";
			if(bowl.length>1)
				label = label+"<FONT COLOR=RED>Too many bowling ball letters are being used ("+bowl+")</FONT><P>";
		}
		if(paused)
			label = label+"You are analyzing a previously played frame<P>"+"Click \"Next Frame\" to move on to the next set of pins";
		document.getElementById("messages").innerHTML=label;

		updateStrikeLabel();

		let limit = (getPref);
		for(var i=0;i<11;i++) {
			const canvas = document.getElementById("scoreArea"+i);
			const context = canvas.getContext("2d");
			drawScoreArea(context, i);
		}
		const canvas = document.getElementById("totalScoreArea");
		const context = canvas.getContext("2d");
		drawTotalScore(context);
	}

	function shapeToString(mask) {
		var list = [];
		for(var i=0;i<10;i++) {
			if((mask & (1<<i))!=0)
				list.push(pinSets[displayFrame][i]);
		}
		list.sort();
		return list.join("");
	}
 
	function determinePinkness(green, red) {
		if(red!=0)
			return green;
		if(connectedMask[green])
			return 0;
		return green;
	}

	function card(x) {
		x=((x&0xAAAAAAAA)>>1) + (x&0x55555555);
		x=((x&0xCCCCCCCC)>>2) + (x&0x33333333);
		x=((x&0xF0F0F0F0)>>4) + (x&0x0F0F0F0F);
		x=((x&0xFF00FF00)>>8) + (x&0x00FF00FF);
		x=((x&0xFFFF0000)>>16) + (x&0x0000FFFF);
		return x;
	}

	function determineOutlineColor(p,g,r,i) {
		if(p&i)
			return "pink";
		if(g&i)
			return "green";
		if(r&i)
			return "red";
		return "white";
	}

	function drawTotalScore(context) {
		const saveFill = context.fillStyle;
		context.fillStyle = "white";
		context.fillRect(0,0,SCORE_WIDTH,SCORE_HEIGHT);
		context.fillStyle = saveFill;
		context.font = "15px Arial";
		drawText(context,SCORE_WIDTH/2,SCORE_HEIGHT/2,""+calculateTotalScore());
	}

	function drawScoreArea(context, frame) {
		if(frame==10 && getPref("currentFrameScoring"))
			return;
		const saveFill = context.fillStyle;
		context.fillStyle = "white";
		context.fillRect(0,0,SCORE_WIDTH,SCORE_HEIGHT);
		context.fillStyle = saveFill;
		context.strokeRect(1,1,SCORE_WIDTH-1,SCORE_HEIGHT-1);
		if(frame==displayFrame) {
			context.strokeRect(2,2,SCORE_WIDTH-3,SCORE_HEIGHT-3);
			context.strokeRect(3,3,SCORE_WIDTH-5,SCORE_HEIGHT-5);
		}
		context.beginPath();
		context.moveTo(1,SCORE_HEIGHT-1);
		context.lineTo(SCORE_WIDTH-1,1);
		context.stroke();
		if(topScores[frame]==10) {
			drawText(context,SCORE_WIDTH/4,SCORE_HEIGHT/4,"X");
			if(bottomScores[frame]==10)
				drawText(context,3*SCORE_WIDTH/4,3*SCORE_HEIGHT/4,"X");
			else if(bottomScores[frame]>=0)
				drawText(context,3*SCORE_WIDTH/4,3*SCORE_HEIGHT/4,""+bottomScores[frame]);
		} else if(topScores[frame]>=0) {
			drawText(context,SCORE_WIDTH/4,SCORE_HEIGHT/4,""+topScores[frame]);
			if(bottomScores[frame]+topScores[frame]==10)
				drawText(context,3*SCORE_WIDTH/4,3*SCORE_HEIGHT/4,"/");
			else if(bottomScores[frame]>=0)
				drawText(context,3*SCORE_WIDTH/4,3*SCORE_HEIGHT/4,""+bottomScores[frame]);
		}
	}

	let pinPoints = [[0.50,0.00],
			[0.52,0.00], [0.60,0.08], [0.60,0.10],
			[0.60,0.12], [0.58,0.28], [0.58,0.30],
			[0.58,0.32], [0.70,0.55], [0.70,0.60],
			[0.70,0.65], [0.60,0.95], [0.55,1.00],
			[0.53,1.00], [0.50,1.00], [0.45,1.00],
			[0.40,0.95], [0.30,0.65], [0.30,0.60],
			[0.30,0.55], [0.42,0.32], [0.42,0.30],
			[0.42,0.28], [0.40,0.12], [0.40,0.10],
			[0.40,0.08], [0.48,0.00], [0.50,0.00]
	];

	function drawBowlingPin(context,x,y,text,outline,down) {
		const saveStroke = context.strokeStyle;
		const saveLineWidth = context.lineWidth;
		const saveFill = context.fillStyle;
		context.fillStyle = "white";
		context.fillRect(x,y,ICON_WIDTH,ICON_HEIGHT);
		context.strokeStyle = outline;
		context.lineWidth = 4;
		context.strokeRect(x,y,ICON_WIDTH,ICON_HEIGHT);
		context.strokeStyle = saveStroke;
		context.lineWidth = saveLineWidth;
		if(down) {
			context.beginPath();
			context.moveTo(x+tY(0),y+tX(0));
			for(var i=1;i<pinPoints.length;i+=3) {
				context.bezierCurveTo(x+tY(i+0),y+tX(i+0),x+tY(i+1),y+tX(i+1),x+tY(i+2),y+tX(i+2));
			}
			context.fillStyle="lightgray";
			context.fill();
			context.stroke();

			context.beginPath();
			context.moveTo(x+tY(6),y+tX(6));
			context.lineTo(x+tY(21),y+tX(21));
			context.lineTo(x+tY(21)-ICON_HEIGHT/20,y+tX(21));
			context.lineTo(x+tY(6)-ICON_HEIGHT/20,y+tX(6));
			context.fillStyle="red";
			context.fill();
		
			context.beginPath();
			context.moveTo(x+tY(6)-2*ICON_HEIGHT/20,y+tX(6));
			context.lineTo(x+tY(21)-2*ICON_HEIGHT/20,y+tX(21));
			context.lineTo(x+tY(21)-3*ICON_HEIGHT/20,y+tX(21));
			context.lineTo(x+tY(6)-3*ICON_HEIGHT/20,y+tX(6));
			context.fill();
			context.fillStyle=saveFill;
		
			drawText(context,x+2*ICON_WIDTH/3,y+ICON_HEIGHT/2,text);
		} else {
			context.beginPath();
			context.moveTo(x+tX(0),y+tY(0));
			for(var i=1;i<pinPoints.length;i+=3) {
				context.bezierCurveTo(x+tX(i+0),y+tY(i+0),x+tX(i+1),y+tY(i+1),x+tX(i+2),y+tY(i+2));
			}
			context.fillStyle="white";
			context.fill();
			context.stroke();
		
			context.beginPath();
			context.moveTo(x+tX(6),y+tY(6));
			context.lineTo(x+tX(21),y+tY(21));
			context.lineTo(x+tX(21),y+tY(21)-ICON_HEIGHT/20);
			context.lineTo(x+tX(6),y+tY(6)-ICON_HEIGHT/20);
			context.fillStyle="red";
			context.fill();
		
			context.beginPath();
			context.moveTo(x+tX(6),y+tY(6)-2*ICON_HEIGHT/20);
			context.lineTo(x+tX(21),y+tY(21)-2*ICON_HEIGHT/20);
			context.lineTo(x+tX(21),y+tY(21)-3*ICON_HEIGHT/20);
			context.lineTo(x+tX(6),y+tY(6)-3*ICON_HEIGHT/20);
			context.fill();
			context.fillStyle=saveFill;
		
			drawText(context,x+ICON_WIDTH/2,y+2*ICON_HEIGHT/3,text);
		}
	}

	function tX(i) {
		return pinPoints[i][0]*ICON_WIDTH;
	}

	function tY(i) {
		return pinPoints[i][1]*ICON_HEIGHT;
	}

	function drawText(context,x,y,text) {
		const metrics = context.measureText(text);
		context.fillText(text,x-metrics.width/2,y-(metrics.emHeightDescent-metrics.emHeightAscent)/2);
	}

	parseGame = function(gameText) {
		let game = gameText.split("\n");
		let line = game[0].split(" ");
		let seed = parseInt(line[0],16);
		playerName = game[1];
		dictionaryFile=((game[2].length==0) ? null : game[2]);
		dictionaryHash=game[3];
		startGame(seed,parseInt(line[1]));
		for(var i=4;i<game.length;i++) {
			line = game[i].split(" ");
			if(line.length==1)
				continue;
			if(paused) {
				displayFrame = frame;
				setPaused(false);
			}
			downShape = parseInt(line[2]);
			if(updateFrame(line[0], parseInt(line[3]))) {
				strikeFrame = frame;
				endFrame();
				downShape=0;
				if(!getPref("autoAdvance"))
					timeTravel(strikeFrame);
			}
		}
		clearWordEntry();
		update(true);
	}

	startGame = function(seed, startTime) {
		localStorage.game="";
		paused=false;
		frame=0;
		displayFrame=0;
		strikeFrame=-1;
		if(!seed) {
			if(nextSeed)
				seed=nextSeed;
			else
				seed=todaySeed();
		}
		if(!startTime)
			startTime=Date.now();
		appendGame(seed.toString(16).padStart(8,'0')+" "+startTime);
		appendGame(playerName);
		appendGame(dictionaryFile==null ? "" : dictionaryFile);
		appendGame(dictionaryHash);
		appendGame("");
		updateSeedButton(seed);
		rng = mulberry32(seed);
		for(var f=0;f<12;f++) {
			getPinSet(f);
			topScores[f]=-1;
			bottomScores[f]=-1;
		}
		downShape = 0;
		green = 0;;
		pink = 0;;
		red = 0;;
		clearWords();
		nextSeed = rng();
		clearWordEntry();
		update(true);
	}

	function clearWords() {
		for(var i=0;i<22;i++) {
			document.getElementById("word"+i).textContent="";
		}
	}

	function clearWordEntry() {
		document.getElementById("word").value="";
		document.getElementById("word").focus();
		
	}

	function updateSeedButton(seed) {
		seed = seed.toString(16).padStart(8,'0');
		document.getElementById("seed").textContent=seed;
		document.getElementById("seedSpan").textContent=seed;
	}

	function generateValidStrikes() {
		validStrikes = [];
		for(var w=0;w<dictionary.length;w++) {
			const word = dictionary[w];
			if(word.length<=10)
				continue;
			for(var i=0;i<word.length;i++) {
				const ch = word[i];
				if(ch<=' ')
					continue;
				var countChar=0;
				for(var j=0;j<word.length;j++) {
					if(word[j]==ch)
						countChar++;
				}
				if(countChar==word.length-10) {
					validStrikes.push(word);
					break;
				}
			}
		}
		if(validStrikes.length==0) {
			window.confirm("There are no valid strikes!");
			console.log("No valid strikes!");
		} else {
			//console.log(validStrikes.length+" valid strikes!");
		}
	}

	function getPinSet(index) {
		for(var i=0;i<index;i++)
			rng();
		var count=0;
		if(validStrikes.length==0) {
			pinSets[index]="";
			strikeWords[index]="";
			strikeBalls[index]="";
			return;
		}
		const word = validStrikes[rng()%validStrikes.length];
		for(var i=0;i<word.length;i++) {
			const ch = word[i];
			if(ch<=' ')
				continue;
			var countChar=0;
			for(var j=0;j<word.length;j++) {
				if(word[j]==ch)
					countChar++;
			}
			if(countChar==word.length-10) {
				if((rng()%(++count))==0) {
					pinSets[index] = strip(word,ch);
					strikeWords[index] = word;
					strikeBalls[index] = ""+ch;
				}
			}

		}
		if(count==0) {
			console.log("Something went wrong: "+word);
			pinSets[index]="";
			strikeWords[index]="";
			strikeBalls[index]="";
		}
	}

	function strip(word,char) {
		var output=[];
		for(var i=0;i<word.length;i++)
			if(word[i]!=char && word[i]>' ')
				output.push(word[i]);
		if(output.length!=10)
			console.out(word+" should have 10 valid characters, other than "+char);
		for(var i=output.length-1;i>0;i--) {
			const j=rng()%(i+1);
			const swap=output[j];
			output[j]=output[i];
			output[i]=swap;
		}
		return output.join("");
	}

	function appendGame(line) {
		console.log(line);
		localStorage.game=localStorage.game+line+"\n";
	}

	function getDateString() {
		const date = new Date();
		return date.getFullYear()+"-"+((date.getMonth()+1+"").padStart(2,"0"))+"-"+((date.getDate()+"").padStart(2,"0"));
	}

	function todaySeed() {
		return parseInt(MD5(getDateString()).slice(-8),16);
	}

	function randomSeed() {
		const bytes = new Uint8Array(4);
		window.crypto.getRandomValues(bytes);
		return bytes[0]+(bytes[1]+(bytes[2]+bytes[3]*256)*256)*256;
	}

	function mulberry32(a) {
		return function() {
//console.log(a.toString(16));
			var t = a += 0x6D2B79F5;
//console.log(t);
			t = Math.imul(t ^ t >>> 15, t | 1);
//console.log(t);
			t ^= t + Math.imul(t ^ t >>> 7, t | 61);
//console.log(t);
			t = ((t ^ t >>> 14) >>> 0);
//console.log(t.toString(16));
			return t;
		}
	}

	// https://stackoverflow.com/questions/14733374/how-to-generate-an-md5-file-hash-in-javascript-node-js#33486055
	var MD5 = function(d) {
		var r = M(V(Y(X(d),8*d.length)));
		return r.toLowerCase()
	};
	function M(d) {
		for(var _,m="0123456789ABCDEF",f="",r=0;r<d.length;r++)
			_=d.charCodeAt(r),f+=m.charAt(_>>>4&15)+m.charAt(15&_);
		return f
	}
	function X(d) {
		for(var _=Array(d.length>>2),m=0;m<_.length;m++)
			_[m]=0;
		for(m=0;m<8*d.length;m+=8)
			_[m>>5]|=(255&d.charCodeAt(m/8))<<m%32;
		return _
	}
	function V(d) {
		for(var _="",m=0;m<32*d.length;m+=8)
			_+=String.fromCharCode(d[m>>5]>>>m%32&255);
		return _
	}
	function Y(d,_) {
		d[_>>5]|=128<<_%32,d[14+(_+64>>>9<<4)]=_;
		for(var m=1732584193,f=-271733879,r=-1732584194,i=271733878,n=0;n<d.length;n+=16) {
			var h=m,t=f,g=r,e=i;
			f=md5_ii(f=md5_ii(f=md5_ii(f=md5_ii(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_ff(f=md5_ff(f=md5_ff(f=md5_ff(f,r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+0],7,-680876936),f,r,d[n+1],12,-389564586),m,f,d[n+2],17,606105819),i,m,d[n+3],22,-1044525330),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+4],7,-176418897),f,r,d[n+5],12,1200080426),m,f,d[n+6],17,-1473231341),i,m,d[n+7],22,-45705983),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+8],7,1770035416),f,r,d[n+9],12,-1958414417),m,f,d[n+10],17,-42063),i,m,d[n+11],22,-1990404162),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+12],7,1804603682),f,r,d[n+13],12,-40341101),m,f,d[n+14],17,-1502002290),i,m,d[n+15],22,1236535329),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+1],5,-165796510),f,r,d[n+6],9,-1069501632),m,f,d[n+11],14,643717713),i,m,d[n+0],20,-373897302),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+5],5,-701558691),f,r,d[n+10],9,38016083),m,f,d[n+15],14,-660478335),i,m,d[n+4],20,-405537848),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+9],5,568446438),f,r,d[n+14],9,-1019803690),m,f,d[n+3],14,-187363961),i,m,d[n+8],20,1163531501),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+13],5,-1444681467),f,r,d[n+2],9,-51403784),m,f,d[n+7],14,1735328473),i,m,d[n+12],20,-1926607734),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+5],4,-378558),f,r,d[n+8],11,-2022574463),m,f,d[n+11],16,1839030562),i,m,d[n+14],23,-35309556),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+1],4,-1530992060),f,r,d[n+4],11,1272893353),m,f,d[n+7],16,-155497632),i,m,d[n+10],23,-1094730640),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+13],4,681279174),f,r,d[n+0],11,-358537222),m,f,d[n+3],16,-722521979),i,m,d[n+6],23,76029189),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+9],4,-640364487),f,r,d[n+12],11,-421815835),m,f,d[n+15],16,530742520),i,m,d[n+2],23,-995338651),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+0],6,-198630844),f,r,d[n+7],10,1126891415),m,f,d[n+14],15,-1416354905),i,m,d[n+5],21,-57434055),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+12],6,1700485571),f,r,d[n+3],10,-1894986606),m,f,d[n+10],15,-1051523),i,m,d[n+1],21,-2054922799),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+8],6,1873313359),f,r,d[n+15],10,-30611744),m,f,d[n+6],15,-1560198380),i,m,d[n+13],21,1309151649),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+4],6,-145523070),f,r,d[n+11],10,-1120210379),m,f,d[n+2],15,718787259),i,m,d[n+9],21,-343485551),m=safe_add(m,h),f=safe_add(f,t),r=safe_add(r,g),i=safe_add(i,e)
		}
		return Array(m,f,r,i)
	}
	function md5_cmn(d,_,m,f,r,i) {
		return safe_add(bit_rol(safe_add(safe_add(_,d),safe_add(f,i)),r),m)
	}
	function md5_ff(d,_,m,f,r,i,n) {
		return md5_cmn(_&m|~_&f,d,_,r,i,n)
	}
	function md5_gg(d,_,m,f,r,i,n) {
		return md5_cmn(_&f|m&~f,d,_,r,i,n)
	}
	function md5_hh(d,_,m,f,r,i,n) {
		return md5_cmn(_^m^f,d,_,r,i,n)
	}
	function md5_ii(d,_,m,f,r,i,n) {
		return md5_cmn(m^(_|~f),d,_,r,i,n)
	}
	function safe_add(d,_) {
		var m=(65535&d)+(65535&_);
		return (d>>16)+(_>>16)+(m>>16)<<16|65535&m
	}
	function bit_rol(d,_) {
		return d<<_|d>>>32-_
	}

	function generateConnectedMask() {
		for(var i=0;i<1024;i++)
			connectedMask.push(isConnected(i));
	}

	function isConnected(mask) {
		if((mask & 0x26F)==0)
			return false;
		for(var i=0;i<10;i++) {
			if(mask & (1<<i))
				return removePiece(mask,i)==0;
		}
	}

	function removePiece(mask, location) {
		if((mask & (1<<location))==0)
			return mask;
		mask -= (1<<location);
		for(var i=0;i<10;i++) {
			if(i==location)
				continue;
			var dx = x[i]-x[location];
			var dy = y[i]-y[location];
			if(dy>=-2 && dy<=2 && dx>=-1 && dx<=1)
				mask = removePiece(mask, i);
		}
		return mask;
	}

	window.onload = function() {
		savedGame = localStorage.game;
		savedHash = null;
		for(var i=0;i<6;i++) {
			const canvas = document.getElementById("bb"+i);
			const context = canvas.getContext("2d");
			drawBowlingPin(context,0,0,"","white",false);
		}
		applyDefaultMenuPrefs();
		gotoHelp("main");

		let inputElem = document.querySelector('input');
		inputElem.addEventListener('input', () => {
			update(true);
		});
		document.getElementById("word").addEventListener("keypress", function(event) {
			if(event.key === "Enter") {
				event.preventDefault();
				document.getElementById("bowl").click();
			}
		});

		generateConnectedMask();

		// For later:
		// Loading a dictionary automatically starts a new game, which MUST BE SAVED to localstorage, 
		// so we don't get out of sync.
		// If I allow loading/saving a game, then I also need to track the dictionary.  Current Logic:
		//	If the current dictionary matches the desired dictionary, don't do anything
		//	If the desired dictionary is the default, reaload it.
		//	Otherwise, prompt the user to load it by name.....
		if(true && localStorage.game) {
			game = localStorage.game.split("\n");
			if(game.length<4) {
			} else if(game[2].length==0) {
				dictionaryFile=null;
				dictionaryHash=defaultDictionaryHash;
				dictionary = defaultDictionary;
				generateValidStrikes();
				parseGame(localStorage.game);
				return;
			} else {
				window.confirm("For security reasons, I cannot autoload dictionaries.  You'll need to load the dictionary "+game[2]+", then Restore Game");
				savedHash=game[3];
			}
		} 
		dictionaryFile=null;
		dictionaryHash=defaultDictionaryHash;
		dictionary = defaultDictionary;
		generateValidStrikes();
		startGame(todaySeed(),null);
	}

	function applyDefaultMenuPrefs() {
		applyDefaultMenuPref("autoAdvance",false);
		applyDefaultMenuPref("checkWords",true);
		applyDefaultMenuPref("hideStrike",false);
		applyDefaultMenuPref("currentFrameScoring",true);
		applyDefaultMenuPref("allowGutterBalls",true);
	}

	function resetMenuPrefs() {
		resetClick(0);
		resetMenuPref("autoAdvance",false);
		resetMenuPref("checkWords",true);
		resetMenuPref("hideStrike",false);
		resetMenuPref("currentFrameScoring",true);
		resetMenuPref("allowGutterBalls",true);
		update(false);
	}

	function resetMenuPref(key, value) {
		localStorage[key] = value;
		document.getElementById(key+"Check").style.visibility=(getPref(key)?"visible":"hidden");
	}

	function toggleMenuPref(key) {
		resetClick(0);
		localStorage[key] = !getPref(key);
		document.getElementById(key+"Check").style.visibility=(getPref(key)?"visible":"hidden");
		update(false);
	}

	function applyDefaultMenuPref(key, defaultValue) {
		localStorage[key] = localStorage[key] || defaultValue;
		document.getElementById(key+"Check").style.visibility=(getPref(key)?"visible":"hidden");
	}

	function getPref(key) {
		return localStorage[key] === "true";
	}

	function bowl() {
		resetClick(0);
		let word = getSanitizedWord();
		if(!isInDictionary(word)) {
			if(!window.confirm("That word is not in my dictionary.  Use anyway?"))
				return;
			word = "*_"+word+"_*";
		}
		count = card(green | downShape);
		if(updateFrame(word, count)) {
			strikeFrame=frame;
			endFrame();
			downShape=0;
			if(getPref("autoAdvance")) {
				enableButton("nextFrame",true);
			} else {
				timeTravel(strikeFrame);
			}
		}
		clearWordEntry();
		update(false);
	}

	function updateFrame(word,count) {
		downShape = green;
		appendGame(word+" "+frame+" "+downShape+" "+count);
		let topScore = topScores[frame];
		if(topScore>=0) {
			document.getElementById("word"+(frame*2+1)).textContent=word;
			bottomScores[frame]=(count-topScore);
			return true;
		}
		document.getElementById("word"+(frame*2)).textContent=word;
		if(frame==11) {
			bottomScores[frame-1]=topScore;
			return true;
		} else {
			topScores[frame]= count;
			if(frame<10 && count==10) {
				document.getElementById("word"+(frame*2+1)).textContent="-----";
				appendGame("-----");
			}
		}
		return (count==10) || (frame==10 && topScores[frame-1]!=10);
	}

	function calculateTotalScore() {
		let totalScore=0;
		for(var f=0;f<12;f++) {
			let topScore = topScores[f];
			if(topScore<0)
				topScore=0;
			let bottomScore = bottomScores[f];
			if(bottomScore<0)
				bottomScore=0;
			if(getPref("currentFrameScoring")) {
				if(f<10) {
					if(topScore==10)
						totalScore += 30;
					else if(bottomScore + topScore==10)
						totalScore += 10+topScore;
					else
						totalScore += topScore+bottomScore;
				}
			} else {
				if(f<10) {
					totalScore += topScore;
					totalScore += bottomScore;
				}
				if(f>0 && topScores[f-1]==10) {
					totalScore += topScore;
					totalScore += bottomScore;
					if((f>1)  && topScores[f-2]==10)
						totalScore += topScore;
				} else if(f>0 && topScores[f-1] + bottomScores[f-1]==10) {
					totalScore += topScore;
				}
			}
		}
		return totalScore;
	}

	function endFrame() {
		if(frame>=10) {
			if(frame==10 && topScores[frame-1]==10 && topScores[frame]==10) {
				frame=11;
				displayFrame=frame;
				return;
			}
			frame=11;
			displayFrame=frame;
			update();
			checkEndGame();
			return;
		}
		frame++;
		displayFrame=frame;
		if(frame==10) {
			if(!getPref("currentFrameScoring")) {
				if(topScores[frame-1]==10 || topScores[frame-1]+bottomScores[frame-1]==10)
					return;
			}
			update();
			checkEndGame();
			return;
		}
	}

	function checkEndGame() {
		if(window.confirm("The game is over.  Do you wish to play again?"))
			startGame(null,null);
		else
			setPaused(true);
	}

	function enableButton(id, value) {
		if(value)
			document.getElementById(id).removeAttribute("disabled");
		else
			document.getElementById(id).setAttribute("disabled","true");
	}

	function todayGame() {
		resetClick(0);
		gotoHelp("main");
		reply = window.confirm("Do you wish to start a new game with today's random seed?");
		if(reply)
			startGame(todaySeed(),null);
	}

	function nextGame() {
		resetClick(0);
		gotoHelp("main");
		reply = window.prompt("Do you wish to start the next game?",nextSeed.toString(16));
		if(reply)
			startGame(parseInt(reply,16),null);
	}

	function randomGame() {
		resetClick(0);
		gotoHelp("main");
		reply = window.prompt("Do you wish to start a new random game?",randomSeed().toString(16));
		if(reply)
			startGame(parseInt(reply,16),null);
	}

	function restoreGame() {
		resetClick(0);
		gotoHelp("main");
		if(savedHash && (savedHash !== dictionaryHash)) {
			window.confirm("Currently loaded dictionary with hash "+dictionaryHash+" does not match saved game "+savedHash);
			return;
		}
		reply = window.confirm("Do you wish to restore the saved game?");
		if(reply)
			parseGame(savedGame);
	}

	function openGame() {
		resetClick(0);
		gotoHelp("main");
		document.getElementById("openFile").click();
	}

	function readGame(e) {
		var file = e.target.files[0];
		if (!file)
			return;
		var reader = new FileReader();
		reader.onload = function(e) {
			game = e.target.result.split("\n");
			if(game.length<4) {
				window.confirm("Unable to read game file.");
			} else if(game[2].length==0) {
				dictionaryFile=null;
				dictionaryHash=defaultDictionaryHash;
				dictionary = defaultDictionary;
				generateValidStrikes();
				parseGame(e.target.result);
			} else if(game[3] === dictionaryHash) {
				parseGame(e.target.result);
			} else {
				savedGame = game;
				savedHash = game[3];
				window.confirm("For security reasons, I cannot autoload dictionaries.  You'll need to load the dictionary "+game[2]+", then Restore Game");
			}
		}
		reader.readAsText(file);
	}

	function downloadGame() {
		resetClick(0);
		gotoHelp("main");
		const url = URL.createObjectURL(new Blob([localStorage.game]));
		const a = document.createElement('a');
		a.href = url;
		a.download = playerName+".LetterBowling.txt";
		const clickHandler = () => {
			setTimeout(() => {
				URL.revokeObjectURL(url);
				removeEventListener('click', clickHandler);
			}, 150);
		};
		a.addEventListener('click',clickHandler,false);
		setTimeout(function(){a.click()},100);
	}

	function changeDictionary() {
		resetClick(0);
		gotoHelp("main");
		if(false) {
			window.confirm("Custom dictionaries are not yet implemented.");
			return;
		}
		newHash=null;
		newGame=null;
		document.getElementById("openDictionary").click();
	}

	function readDictionary(e) {
		var file = e.target.files[0];
		if (!file) {
			if(!localStorage.game) {
				dictionaryFile=null;
				dictionaryHash=defaultDictionaryHash;
				dictionary = defaultDictionary;
				generateValidStrikes();
				startGame(todaySeed(),null);
			}
			return;
		}
		var reader = new FileReader();
		reader.onload = function(e) {
			const newDictionaryHash = MD5(e.target.result);
			if(newHash && newHash !== newDictionaryHash) {
				window.confirm("Hash "+newDictionaryHash+" does not match expected "+dictionaryHash);
				if(!localStorage.game)
					startGame(todaySeed(),null);
				return;
			}
			dictionaryFile = file.name;
			dictionaryHash = newDictionaryHash;
			dictionary = e.target.result.split("\n");
			generateValidStrikes();
			if(newGame)
				parseGame(newGame);
			else
				startGame(parseInt(document.getElementById("seed").textContent,16),null);
		};
		reader.readAsText(file);
	}

	function resetDictionary() {
		resetClick(0);
		gotoHelp("main");
		reply = window.confirm("Do you want to start a new game with the SOWPODS dictionary");
		if(reply) {
			dictionaryFile = null;
			dictionaryHash = defaultDictionaryHash;
			dictionary = defaultDictionary;
			generateValidStrikes();
			startGame(parseInt(document.getElementById("seed").textContent,16),null);
		}
	}

	function nextFrame() {
		if(displayFrame != frame) {
			displayFrame=frame;
			setPaused(savePaused);
			downShape=saveDownShape;
		}
		if(paused) {
			strikeFrame=frame;
			endFrame();
		}
		setPaused(false);
		enableButton("nextFrame",false);
		downShape=0;
		clearWordEntry();
		update(false);
	}


	function timeTravel(ff) {
		if(ff>frame || ff==displayFrame)
			return;
		if(displayFrame==frame) {
			savePaused=paused;
			saveDownShape=downShape;
		}
		if(ff==frame) {
			setPaused(savePaused);
		} else {
			setPaused(true);
		}
		displayFrame=ff;
		if(paused) {
			downShape=0;
		} else {
			downShape=saveDownShape;
		}
		clearWordEntry();
		update(false);
	}

	function updateStrikeLabel(f) {
		var f = paused ? displayFrame : strikeFrame;
		var text;
		if(getPref("hideStrike") || f<0)
			text="";
		else
			text="The srike for "+getFrameName(f)+ " was: "+strikeWords[f]+" ("+strikeBalls[f]+")";
		document.getElementById("strike").textContent=text;
	}

	function getFrameName(f) {
		if(f<10)
			return "frame "+(f+1);
		if(f==10)
			return "the first extra frame";
		if(f==11)
			return "the second extra frame";
		return "unknown frame";
	}

	function setPaused(pause) {
		paused = pause;
		enableButton("nextFrame",paused);
		document.getElementById("bowl").textContent=(paused ? "Paused" : "Bowl");
	}

	function resetClick(skip) {
		if(skip!=1)
			document.getElementById("fileDropdown").classList.remove("show");
		if(skip!=2)
			document.getElementById("settingsDropdown").classList.remove("show");
		if(skip!=3)
			document.getElementById("helpDropdown").classList.remove("show");
	}

	function menuFile() {
		resetClick(1);
		document.getElementById("fileDropdown").classList.toggle("show");
	}

	function menuSettings() {
		resetClick(2);
		document.getElementById("settingsDropdown").classList.toggle("show");
	}

	function menuHelp() {
		resetClick(3);
		document.getElementById("helpDropdown").classList.toggle("show");
	}

	function gotoHelp(page) {
		resetClick(0);
		updateHelp("main",page);
		updateHelp("helpOverview",page);
		updateHelp("helpThrow",page);
		updateHelp("helpWords",page);
		updateHelp("helpScore",page);
		updateHelp("helpGeeks",page);
		updateHelp("helpAbout",page);
	}

	function updateHelp(div, page) {
		if(div===page)
			document.getElementById(div).style.display="block";
		else
			document.getElementById(div).style.display="none";
	}

	function frameClick(frame) {
		resetClick(0);
		timeTravel(frame);
	}

	function pinClick(pin) {
		resetClick(0);
		if(red & (1<<pin))
			return;
		pinColor = ((green | pink)>>pin) & 1;
		for(var i=0;i<10;i++) {
			iColor = ((green | pink)>>i) & 1;
			if(pinSets[displayFrame][i]!=pinSets[displayFrame][pin] || iColor==pinColor)
				continue;
			if(green & ((1<<i) | (1<<pin)))
				green ^= (1<<i) | (1<<pin);
			else
				pink ^= (1<<i) | (1<<pin);
			update(false);
			break;
		}
	}
</script>
<script src="./dictionary.js"></script>
</body>
</html>
